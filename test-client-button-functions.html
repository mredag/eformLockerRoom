<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Button Function Tests</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #5a6fd8;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-info { color: #17a2b8; }
        .log-warning { color: #ffc107; }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
        .clear-logs {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            float: right;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">ðŸ§ª Locker Button Function Tests</div>
        <p>This page tests all button functions from the locker management interface with detailed logging.</p>
        
        <div>
            <button class="test-button" onclick="testRefreshFunction()">Test Refresh Button</button>
            <button class="test-button" onclick="testLockerSelection()">Test Locker Selection</button>
            <button class="test-button" onclick="testOpenButton()">Test Open Button</button>
            <button class="test-button" onclick="testBlockButton()">Test Block Button</button>
            <button class="test-button" onclick="testUnblockButton()">Test Unblock Button</button>
            <button class="test-button" onclick="testEndOfDayButton()">Test End of Day</button>
            <button class="test-button" onclick="runAllTests()">Run All Tests</button>
        </div>
        
        <button class="clear-logs" onclick="clearLogs()">Clear Logs</button>
        <div class="log-container" id="log-container"></div>
    </div>

    <script>
        // Test state
        let testResults = [];
        let currentUser = null;
        let csrfToken = null;
        let selectedLockers = new Set();

        // Logging functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const statusIndicator = document.createElement('span');
            statusIndicator.className = `status-indicator status-${type}`;
            
            logEntry.appendChild(statusIndicator);
            logEntry.appendChild(document.createTextNode(`[${timestamp}] ${message}`));
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function logSuccess(message) { log(message, 'success'); }
        function logError(message) { log(message, 'error'); }
        function logWarning(message) { log(message, 'warning'); }
        function logInfo(message) { log(message, 'info'); }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            testResults = [];
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            logInfo('ðŸš€ Button Function Tester initialized');
            await loadUserInfo();
        });

        async function loadUserInfo() {
            try {
                logInfo('ðŸ” Loading user information...');
                const response = await fetch('/auth/me');
                const data = await response.json();

                if (response.ok && data.user) {
                    currentUser = data.user;
                    csrfToken = data.csrfToken;
                    logSuccess(`âœ… User logged in: ${data.user.username}`);
                    logSuccess(`âœ… CSRF token obtained: ${csrfToken ? 'present' : 'missing'}`);
                } else {
                    logError('âŒ User not logged in - some tests may fail');
                }
            } catch (error) {
                logError(`âŒ Failed to load user info: ${error.message}`);
            }
        }

        async function testRefreshFunction() {
            logInfo('ðŸ”„ Testing Refresh Function (loadData)...');
            
            try {
                // Test kiosk loading
                logInfo('ðŸ“¡ Testing kiosk API...');
                const kioskResponse = await fetch('/api/heartbeat/kiosks');
                logInfo(`ðŸ“Š Kiosk API status: ${kioskResponse.status}`);
                
                if (kioskResponse.ok) {
                    const kioskData = await kioskResponse.json();
                    logSuccess(`âœ… Kiosk data loaded: ${kioskData.data?.kiosks?.length || 0} kiosks, ${kioskData.data?.zones?.length || 0} zones`);
                } else {
                    logError(`âŒ Kiosk API failed: ${kioskResponse.status}`);
                }

                // Test locker loading
                logInfo('ðŸ“¡ Testing locker API...');
                const lockerResponse = await fetch('/api/lockers?kioskId=kiosk-1');
                logInfo(`ðŸ“Š Locker API status: ${lockerResponse.status}`);
                
                if (lockerResponse.ok) {
                    const lockerData = await lockerResponse.json();
                    logSuccess(`âœ… Locker data loaded: ${lockerData.lockers?.length || 0} lockers`);
                    logInfo(`ðŸ“Š Response structure: lockers=${Array.isArray(lockerData.lockers)}, total=${lockerData.total}`);
                } else {
                    logError(`âŒ Locker API failed: ${lockerResponse.status}`);
                }

                testResults.push({
                    test: 'Refresh Function',
                    status: kioskResponse.ok && lockerResponse.ok ? 'PASSED' : 'FAILED'
                });

            } catch (error) {
                logError(`âŒ Refresh function test failed: ${error.message}`);
                testResults.push({ test: 'Refresh Function', status: 'FAILED', error: error.message });
            }
        }

        async function testLockerSelection() {
            logInfo('ðŸŽ¯ Testing Locker Selection...');
            
            try {
                // Simulate locker selection logic
                const testKioskId = 'kiosk-1';
                const testLockerId = 1;
                const key = testKioskId + '-' + testLockerId;
                
                // Test adding selection
                selectedLockers.clear();
                selectedLockers.add(key);
                logInfo(`ðŸ“ Added locker selection: ${key}`);
                logSuccess(`âœ… Selection count: ${selectedLockers.size}`);
                
                // Test removing selection
                selectedLockers.delete(key);
                logInfo(`ðŸ“ Removed locker selection: ${key}`);
                logSuccess(`âœ… Selection count after removal: ${selectedLockers.size}`);
                
                // Test multiple selections
                selectedLockers.add('kiosk-1-1');
                selectedLockers.add('kiosk-1-2');
                selectedLockers.add('kiosk-1-3');
                logSuccess(`âœ… Multiple selections work: ${selectedLockers.size} lockers selected`);
                
                testResults.push({ test: 'Locker Selection', status: 'PASSED' });
                
            } catch (error) {
                logError(`âŒ Locker selection test failed: ${error.message}`);
                testResults.push({ test: 'Locker Selection', status: 'FAILED', error: error.message });
            }
        }

        async function testOpenButton() {
            logInfo('ðŸ”“ Testing Open Button (Bulk Open)...');
            
            if (!csrfToken) {
                logError('âŒ No CSRF token - cannot test open button');
                testResults.push({ test: 'Open Button', status: 'FAILED', error: 'No CSRF token' });
                return;
            }
            
            try {
                const testPayload = {
                    lockers: [
                        { kioskId: 'kiosk-1', lockerId: 1 },
                        { kioskId: 'kiosk-1', lockerId: 2 }
                    ],
                    reason: 'Test bulk open operation',
                    intervalMs: 100
                };
                
                logInfo('ðŸ“¡ Testing bulk open API...');
                logInfo(`ðŸ“Š Payload: ${JSON.stringify(testPayload, null, 2)}`);
                
                const response = await fetch('/api/lockers/bulk/open', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify(testPayload)
                });
                
                logInfo(`ðŸ“Š Bulk open API status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    logSuccess(`âœ… Bulk open successful: ${data.successCount}/${data.totalCount} lockers opened`);
                    logInfo(`ðŸ“Š Response: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    logError(`âŒ Bulk open failed: ${errorData.error || errorData.message}`);
                }
                
                testResults.push({
                    test: 'Open Button',
                    status: response.ok ? 'PASSED' : 'FAILED'
                });
                
            } catch (error) {
                logError(`âŒ Open button test failed: ${error.message}`);
                testResults.push({ test: 'Open Button', status: 'FAILED', error: error.message });
            }
        }

        async function testBlockButton() {
            logInfo('ðŸš« Testing Block Button...');
            
            if (!csrfToken) {
                logError('âŒ No CSRF token - cannot test block button');
                testResults.push({ test: 'Block Button', status: 'FAILED', error: 'No CSRF token' });
                return;
            }
            
            try {
                const testKioskId = 'kiosk-1';
                const testLockerId = 1;
                const testPayload = { reason: 'Test block operation' };
                
                logInfo(`ðŸ“¡ Testing block API for locker ${testKioskId}-${testLockerId}...`);
                logInfo(`ðŸ“Š Payload: ${JSON.stringify(testPayload)}`);
                
                const response = await fetch(`/api/lockers/${testKioskId}/${testLockerId}/block`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify(testPayload)
                });
                
                logInfo(`ðŸ“Š Block API status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    logSuccess(`âœ… Block successful: ${data.message}`);
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    logError(`âŒ Block failed: ${errorData.error || errorData.message}`);
                }
                
                testResults.push({
                    test: 'Block Button',
                    status: response.ok ? 'PASSED' : 'FAILED'
                });
                
            } catch (error) {
                logError(`âŒ Block button test failed: ${error.message}`);
                testResults.push({ test: 'Block Button', status: 'FAILED', error: error.message });
            }
        }

        async function testUnblockButton() {
            logInfo('âœ… Testing Unblock Button...');
            
            if (!csrfToken) {
                logError('âŒ No CSRF token - cannot test unblock button');
                testResults.push({ test: 'Unblock Button', status: 'FAILED', error: 'No CSRF token' });
                return;
            }
            
            try {
                const testKioskId = 'kiosk-1';
                const testLockerId = 1;
                
                logInfo(`ðŸ“¡ Testing unblock API for locker ${testKioskId}-${testLockerId}...`);
                
                const response = await fetch(`/api/lockers/${testKioskId}/${testLockerId}/unblock`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({})
                });
                
                logInfo(`ðŸ“Š Unblock API status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    logSuccess(`âœ… Unblock successful: ${data.message}`);
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    logError(`âŒ Unblock failed: ${errorData.error || errorData.message}`);
                }
                
                testResults.push({
                    test: 'Unblock Button',
                    status: response.ok ? 'PASSED' : 'FAILED'
                });
                
            } catch (error) {
                logError(`âŒ Unblock button test failed: ${error.message}`);
                testResults.push({ test: 'Unblock Button', status: 'FAILED', error: error.message });
            }
        }

        async function testEndOfDayButton() {
            logInfo('ðŸŒ… Testing End of Day Button...');
            
            if (!csrfToken) {
                logError('âŒ No CSRF token - cannot test end of day button');
                testResults.push({ test: 'End of Day Button', status: 'FAILED', error: 'No CSRF token' });
                return;
            }
            
            try {
                const testPayload = {
                    excludeVip: true,
                    kioskId: 'kiosk-1'
                };
                
                logInfo('ðŸ“¡ Testing end of day API...');
                logInfo(`ðŸ“Š Payload: ${JSON.stringify(testPayload)}`);
                
                const response = await fetch('/api/lockers/end-of-day', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify(testPayload)
                });
                
                logInfo(`ðŸ“Š End of day API status: ${response.status}`);
                logInfo(`ðŸ“Š Content-Type: ${response.headers.get('content-type')}`);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('text/csv')) {
                        const csvData = await response.text();
                        logSuccess(`âœ… End of day successful - CSV generated (${csvData.length} bytes)`);
                        logInfo(`ðŸ“„ CSV preview: ${csvData.substring(0, 100)}...`);
                    } else {
                        const data = await response.json();
                        logSuccess(`âœ… End of day successful: ${JSON.stringify(data)}`);
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    logError(`âŒ End of day failed: ${errorData.error || errorData.message}`);
                }
                
                testResults.push({
                    test: 'End of Day Button',
                    status: response.ok ? 'PASSED' : 'FAILED'
                });
                
            } catch (error) {
                logError(`âŒ End of day button test failed: ${error.message}`);
                testResults.push({ test: 'End of Day Button', status: 'FAILED', error: error.message });
            }
        }

        async function runAllTests() {
            logInfo('ðŸ§ª Running all button function tests...');
            clearLogs();
            testResults = [];
            
            await loadUserInfo();
            await testRefreshFunction();
            await testLockerSelection();
            await testOpenButton();
            await testBlockButton();
            await testUnblockButton();
            await testEndOfDayButton();
            
            // Generate summary
            const passed = testResults.filter(r => r.status === 'PASSED').length;
            const failed = testResults.filter(r => r.status === 'FAILED').length;
            
            logInfo('ðŸ“Š Test Summary:');
            logSuccess(`âœ… Passed: ${passed}`);
            if (failed > 0) {
                logError(`âŒ Failed: ${failed}`);
            }
            logInfo(`ðŸ“ˆ Total: ${testResults.length}`);
            
            if (failed > 0) {
                logWarning('âš ï¸ Some tests failed. Check the logs above for details.');
                logInfo('ðŸ’¡ Common issues:');
                logInfo('  - Not logged in (need to login first)');
                logInfo('  - Services not running');
                logInfo('  - CSRF token missing');
                logInfo('  - Permission issues');
            } else {
                logSuccess('ðŸŽ‰ All tests passed!');
            }
        }

        // Add click event logging for debugging
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.className.includes('test-button')) {
                logInfo(`ðŸ–±ï¸ Button clicked: ${e.target.textContent}`);
            }
        });

        // Add error handler
        window.addEventListener('error', (e) => {
            logError(`ðŸš¨ JavaScript Error: ${e.message} at ${e.filename}:${e.lineno}`);
        });
    </script>
</body>
</html>
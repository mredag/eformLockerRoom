<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eform Panel - Giri≈ü</title>
    <script>
        // Early service worker registration prevention
        if (typeof navigator !== 'undefined' && navigator.serviceWorker) {
            if (!navigator.serviceWorker.register) {
                navigator.serviceWorker.register = function() {
                    console.log('üîß Service worker registration stubbed (early)');
                    return Promise.resolve();
                };
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #666;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-button {
            width: 100%;
            padding: 0.75rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .login-button:hover {
            background: #5a6fd8;
        }

        .login-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border: 1px solid #fcc;
        }

        .success-message {
            background: #efe;
            color: #363;
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border: 1px solid #cfc;
        }

        .password-change-form {
            display: none;
        }

        .password-change-form.active {
            display: block;
        }

        .login-form.hidden {
            display: none;
        }
        /* ---- Codex-like animated background additions ---- */
        #bg {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            display: block;
            z-index: 0; /* below content, above body background */
        }

        .texture::after {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            background:
                radial-gradient(1200px 800px at 60% 40%, transparent 60%, rgba(0,0,0,0.28) 100%),
                repeating-linear-gradient(to bottom, rgba(255,255,255,0.06) 0 1px, transparent 1px 3px);
            opacity: 0.18;
            mix-blend-mode: screen;
        }

        .login-container { position: relative; z-index: 2; }
    </style>
</head>
<body class="texture">
    <!-- Animated background canvas (Codex-like) -->
    <canvas id="bg"></canvas>
    <div class="login-container">
        <div class="login-header">
            <h1>Eform Panel</h1>
            <p>Personel Y√∂netim Aray√ºz√º</p>
        </div>

        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="success-message" class="success-message" style="display: none;"></div>

        <!-- Login Form -->
        <form id="login-form" class="login-form">
            <div class="form-group">
                <label for="username">Kullanƒ±cƒ± Adƒ±</label>
                <input type="text" id="username" name="username" required placeholder="Kullanƒ±cƒ± Adƒ±">
            </div>
            <div class="form-group">
                <label for="password">≈ûifre</label>
                <input type="password" id="password" name="password" required placeholder="≈ûifre">
            </div>
            <button type="submit" class="login-button" id="login-button">Giri≈ü</button>
        </form>

        <!-- Password Change Form -->
        <form id="password-change-form" class="password-change-form">
            <div class="form-group">
                <label for="new-password">Yeni ≈ûifre</label>
                <input type="password" id="new-password" name="newPassword" required minlength="8" placeholder="Yeni ≈üifre">
            </div>
            <div class="form-group">
                <label for="confirm-password">≈ûifre Onayƒ±</label>
                <input type="password" id="confirm-password" name="confirmPassword" required minlength="8" placeholder="≈ûifreyi tekrar girin">
            </div>
            <button type="submit" class="login-button" id="change-password-button">≈ûifreyi Deƒüi≈ütir</button>
        </form>
    </div>

    <script>
        let csrfToken = null;
        let userId = null;

        const loginForm = document.getElementById('login-form');
        const passwordChangeForm = document.getElementById('password-change-form');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const formData = new FormData(loginForm);
            const loginButton = document.getElementById('login-button');
            
            loginButton.disabled = true;
            loginButton.textContent = 'Giri≈ü yapƒ±lƒ±yor...';

            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: formData.get('username'),
                        password: formData.get('password')
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.success) {
                        // Successful login
                        csrfToken = data.csrfToken;
                        window.location.href = '/dashboard.html';
                    }
                } else if (response.status === 403 && data.requiresPasswordChange) {
                    // Password expired
                    userId = data.userId;
                    csrfToken = data.csrfToken;
                    loginForm.classList.add('hidden');
                    passwordChangeForm.classList.add('active');
                    showError('≈ûifrenizin s√ºresi dolmu≈ü. L√ºtfen yeni bir ≈üifre belirleyin.');
                } else {
                    showError(data.error || 'Giri≈ü ba≈üarƒ±sƒ±z');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Giri≈ü';
            }
        });

        passwordChangeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const formData = new FormData(passwordChangeForm);
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');

            if (newPassword !== confirmPassword) {
                showError('≈ûifreler e≈üle≈ümiyor');
                return;
            }

            const changeButton = document.getElementById('change-password-button');
            changeButton.disabled = true;
            changeButton.textContent = 'Deƒüi≈ütiriliyor...';

            try {
                const response = await fetch('/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        newPassword: newPassword,
                        csrfToken: csrfToken
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccess('≈ûifre ba≈üarƒ±yla deƒüi≈ütirildi. L√ºtfen yeni ≈üifrenizle giri≈ü yapƒ±n.');
                    setTimeout(() => {
                        passwordChangeForm.classList.remove('active');
                        loginForm.classList.remove('hidden');
                        loginForm.reset();
                        passwordChangeForm.reset();
                        hideMessages();
                    }, 2000);
                } else {
                    showError(data.error || '≈ûifre deƒüi≈ütirilemedi');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            } finally {
                changeButton.disabled = false;
                changeButton.textContent = '≈ûifreyi Deƒüi≈ütir';
            }
        });

        // Check if already logged in
        fetch('/auth/me')
            .then(response => response.json())
            .then(data => {
                if (data.user && !data.user.passwordExpired) {
                    window.location.href = '/dashboard.html';
                }
            })
            .catch(() => {
                // Not logged in, stay on login page
            });
    </script>
    
    <!-- Animated background script (self-contained, no deps) -->
    <script>
        (function () {
            const canvas = document.getElementById('bg');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            const DPR = Math.min(window.devicePixelRatio || 1, 2);
            let W = 0, H = 0, COLS = 0, ROWS = 0, cellW = 10, cellH = 18;
            const glyphs = [' ', '.', '¬∑', ':', '-', '+', '*', '#'];

            function resize() {
                W = Math.floor(window.innerWidth);
                H = Math.floor(window.innerHeight);
                canvas.width = Math.floor(W * DPR);
                canvas.height = Math.floor(H * DPR);
                canvas.style.width = W + 'px';
                canvas.style.height = H + 'px';
                ctx.setTransform(DPR, 0, 0, DPR, 0, 0);

                const fontSize = Math.max(12, Math.min(16, Math.round(W / 80)));
                ctx.font = `${fontSize}px SFMono-Regular, Menlo, Consolas, Liberation Mono, monospace`;
                ctx.textBaseline = 'middle';

                const metrics = ctx.measureText('M');
                cellW = Math.max(8, Math.floor(metrics.width));
                const approxH = metrics.actualBoundingBoxAscent && metrics.actualBoundingBoxDescent
                    ? Math.floor(metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent)
                    : Math.floor(fontSize * 1.6);
                cellH = Math.max(12, approxH);

                COLS = Math.ceil(W / cellW);
                ROWS = Math.ceil(H / cellH);
            }

            // Tiny value-noise utility
            const Noise = (() => {
                const hash = (x, y) => {
                    const s = Math.sin(x * 127.1 + y * 311.7) * 43758.5453123;
                    return s - Math.floor(s);
                };
                const smooth = t => t * t * (3 - 2 * t);
                const mix = (a, b, t) => a + (b - a) * t;
                const noise2D = (x, y) => {
                    const xi = Math.floor(x), yi = Math.floor(y);
                    const xf = x - xi, yf = y - yi;
                    const a = hash(xi, yi);
                    const b = hash(xi + 1, yi);
                    const c = hash(xi, yi + 1);
                    const d = hash(xi + 1, yi + 1);
                    const ux = smooth(xf); const uy = smooth(yf);
                    return mix(mix(a, b, ux), mix(c, d, ux), uy);
                };
                return { noise2D };
            })();

            window.addEventListener('resize', resize);
            resize();

            let start = performance.now();
            function frame(now) {
                const t = (now - start) / 1000;
                ctx.fillStyle = 'rgba(0,0,0,0.08)';
                ctx.fillRect(0, 0, W, H);
                ctx.fillStyle = 'rgba(210,216,228,0.72)';

                const s1 = 0.12, s2 = 0.035; // spatial scales
                const speed = 0.18, speed2 = 0.07;
                for (let y = 0; y < ROWS; y++) {
                    const py = y * cellH + cellH / 2;
                    const band = 0.55 + 0.45 * Math.sin((y * 0.35) + t * 0.9);
                    for (let x = 0; x < COLS; x++) {
                        const px = x * cellW + 2;
                        const n1 = Noise.noise2D(x * s1 + t * speed, y * s1 - t * speed);
                        const n2 = Noise.noise2D(x * s1 * 1.9 - t * speed * 0.6, y * s2 + t * speed2);
                        const v = (n1 * 0.6 + n2 * 0.6 + band * 0.35);
                        const idx = Math.min(glyphs.length - 1, Math.max(0, (v * glyphs.length) | 0));
                        const g = glyphs[idx];
                        const a = 0.15 + 0.55 * v;
                        ctx.globalAlpha = a;
                        ctx.fillText(g, px, py);
                    }
                }
                ctx.globalAlpha = 1;
                requestAnimationFrame(frame);
            }
            requestAnimationFrame(frame);
        })();
    </script>
    
    <!-- Include i18n script -->
    <script src="/static/i18n.js"></script>
</body>
</html>

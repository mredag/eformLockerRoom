<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eform Panel - GiriÅŸ</title>
    <script>
        // Early service worker registration prevention
        if (typeof navigator !== 'undefined' && navigator.serviceWorker) {
            if (!navigator.serviceWorker.register) {
                navigator.serviceWorker.register = function() {
                    console.log('ðŸ”§ Service worker registration stubbed (early)');
                    return Promise.resolve();
                };
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1d2233;
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-image 0.6s ease-in-out;
        }

        .login-container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #666;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-button {
            width: 100%;
            padding: 0.75rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .login-button:hover {
            background: #5a6fd8;
        }

        .login-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border: 1px solid #fcc;
        }

        .success-message {
            background: #efe;
            color: #363;
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border: 1px solid #cfc;
        }

        .password-change-form {
            display: none;
        }

        .password-change-form.active {
            display: block;
        }

        .login-form.hidden {
            display: none;
        }
        /* ---- Glass look overrides (non-breaking) ---- */
        .login-container.glass {
            background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 20px 60px rgba(0,0,0,0.45);
            backdrop-filter: blur(8px) saturate(120%);
            -webkit-backdrop-filter: blur(8px) saturate(120%);
            color: #cfd3da;
        }
        .login-container.glass .login-header h1 { color: #e8ebf2; }
        .login-container.glass .login-header p { color: #a5acb8; }

        .login-container.glass .form-group label { color: #d4d9e2; }
        .login-container.glass .form-group input {
            background: rgba(18,20,26,0.7);
            color: #e3e7ef;
            border: 1px solid rgba(255,255,255,0.18);
        }
        .login-container.glass .form-group input::placeholder { color: #8b95a8; }
        .login-container.glass .form-group input:focus { border-color: rgba(220,226,238,0.6); }

        .login-container.glass .login-button {
            background: linear-gradient(180deg, #e5e8f0, #cfd4de);
            color: #1b1f28;
            border: none;
            border-radius: 12px;
            font-weight: 700;
        }
        .login-container.glass .login-button:hover { filter: brightness(0.96); }
        .login-container.glass .login-button:disabled { background: #9aa3b5; color: #1b1f28; opacity: 0.7; }

        .login-container.glass .error-message {
            background: rgba(220,53,69,0.12);
            border: 1px solid rgba(220,53,69,0.35);
            color: #ffd6da;
        }
        .login-container.glass .success-message {
            background: rgba(40,167,69,0.12);
            border: 1px solid rgba(40,167,69,0.35);
            color: #d9ffe0;
        }
        .login-container { position: relative; z-index: 1; }
    </style>
</head>
<body>
    <div class="login-container glass">
        <div class="login-header">
            <h1>Eform Panel</h1>
            <p>Personel YÃ¶netim ArayÃ¼zÃ¼</p>
        </div>

        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="success-message" class="success-message" style="display: none;"></div>

        <!-- Login Form -->
        <form id="login-form" class="login-form">
            <div class="form-group">
                <label for="username">KullanÄ±cÄ± AdÄ±</label>
                <input type="text" id="username" name="username" required placeholder="KullanÄ±cÄ± AdÄ±">
            </div>
            <div class="form-group">
                <label for="password">Åžifre</label>
                <input type="password" id="password" name="password" required placeholder="Åžifre">
            </div>
            <button type="submit" class="login-button" id="login-button">GiriÅŸ</button>
        </form>

        <!-- Password Change Form -->
        <form id="password-change-form" class="password-change-form">
            <div class="form-group">
                <label for="new-password">Yeni Åžifre</label>
                <input type="password" id="new-password" name="newPassword" required minlength="8" placeholder="Yeni ÅŸifre">
            </div>
            <div class="form-group">
                <label for="confirm-password">Åžifre OnayÄ±</label>
                <input type="password" id="confirm-password" name="confirmPassword" required minlength="8" placeholder="Åžifreyi tekrar girin">
            </div>
            <button type="submit" class="login-button" id="change-password-button">Åžifreyi DeÄŸiÅŸtir</button>
        </form>
    </div>

    <script>
        let csrfToken = null;
        let userId = null;

        const loginForm = document.getElementById('login-form');
        const passwordChangeForm = document.getElementById('password-change-form');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const formData = new FormData(loginForm);
            const loginButton = document.getElementById('login-button');
            
            loginButton.disabled = true;
            loginButton.textContent = 'GiriÅŸ yapÄ±lÄ±yor...';

            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: formData.get('username'),
                        password: formData.get('password')
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.success) {
                        // Successful login
                        csrfToken = data.csrfToken;
                        window.location.href = '/lockers.html';
                    }
                } else if (response.status === 403 && data.requiresPasswordChange) {
                    // Password expired
                    userId = data.userId;
                    csrfToken = data.csrfToken;
                    loginForm.classList.add('hidden');
                    passwordChangeForm.classList.add('active');
                    showError('Åžifrenizin sÃ¼resi dolmuÅŸ. LÃ¼tfen yeni bir ÅŸifre belirleyin.');
                } else {
                    showError(data.error || 'GiriÅŸ baÅŸarÄ±sÄ±z');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'GiriÅŸ';
            }
        });

        passwordChangeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const formData = new FormData(passwordChangeForm);
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');

            if (newPassword !== confirmPassword) {
                showError('Åžifreler eÅŸleÅŸmiyor');
                return;
            }

            const changeButton = document.getElementById('change-password-button');
            changeButton.disabled = true;
            changeButton.textContent = 'DeÄŸiÅŸtiriliyor...';

            try {
                const response = await fetch('/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        newPassword: newPassword,
                        csrfToken: csrfToken
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccess('Åžifre baÅŸarÄ±yla deÄŸiÅŸtirildi. LÃ¼tfen yeni ÅŸifrenizle giriÅŸ yapÄ±n.');
                    setTimeout(() => {
                        passwordChangeForm.classList.remove('active');
                        loginForm.classList.remove('hidden');
                        loginForm.reset();
                        passwordChangeForm.reset();
                        hideMessages();
                    }, 2000);
                } else {
                    showError(data.error || 'Åžifre deÄŸiÅŸtirilemedi');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            } finally {
                changeButton.disabled = false;
                changeButton.textContent = 'Åžifreyi DeÄŸiÅŸtir';
            }
        });

        // Check if already logged in
        fetch('/auth/me')
            .then(response => response.json())
            .then(data => {
                if (data.user && !data.user.passwordExpired) {
                    window.location.href = '/lockers.html';
                }
            })
            .catch(() => {
                // Not logged in, stay on login page
            });
    </script>
    
    <!-- Cat background loader -->
    <script>
        (function () {
            const body = document.body;
            const defaultBackground = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            const catEndpoints = [
                'https://cataas.com/cat/funny/says/MEOW?width=1600&height=900&color=white&size=48&timestamp=',
                'https://cataas.com/cat/cute/says/Patilerin%20Gucu?width=1600&height=900&color=white&size=42&timestamp=',
                'https://cataas.com/cat/funny/says/MIYAV?width=1600&height=900&color=white&size=54&timestamp='
            ];

            function applyDefaultBackground() {
                body.style.backgroundImage = defaultBackground;
            }

            const randomEndpoint = catEndpoints[Math.floor(Math.random() * catEndpoints.length)];
            const cacheBuster = Date.now().toString(36);
            const catUrl = `${randomEndpoint}${cacheBuster}`;
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.referrerPolicy = 'no-referrer';

            let settled = false;
            const timeoutId = window.setTimeout(() => {
                if (!settled) {
                    settled = true;
                    applyDefaultBackground();
                }
            }, 5000);

            img.onload = () => {
                if (settled) {
                    return;
                }
                settled = true;
                window.clearTimeout(timeoutId);
                body.style.backgroundImage = `url('${catUrl}')`;
                body.style.backgroundColor = '#0d101b';
            };

            img.onerror = () => {
                if (settled) {
                    return;
                }
                settled = true;
                window.clearTimeout(timeoutId);
                applyDefaultBackground();
            };

            img.src = catUrl;
        })();
    </script>

    <!-- Include i18n script -->
    <script src="/static/i18n.js"></script>
</body>
</html>
